<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>co-opt</title>
  <!-- SVG favicon for modern browsers -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <!-- Fallback for Safari and older browsers -->
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%231a4d8f' rx='4'/><text x='16' y='22' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='%23ffffff' text-anchor='middle'>CO</text></svg>">
  <link rel="stylesheet" href="styles.css">
  <!-- Tabulatorã®CSSã¨JSã‚’è¿½åŠ  -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  
  <!-- Plotly.jsæœ€æ–°ç‰ˆã‚’è¿½åŠ  -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <!-- URL Share compression (global LZString) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  
  <!-- WASM Module (V3 with memory management) -->
  <script src="ray-tracing-wasm-v3.js?v=20260103a"></script>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.138.0/build/three.module.js",
        "OrbitControls": "https://unpkg.com/three@0.138.0/examples/jsm/controls/OrbitControls.js"
      }
    }
  </script>



  <script>
    // Warn (in English) when the user tries to leave via the browser Back button.
    // Install early (in <head>) so it works even if heavy scripts delay initialization.
    // Note: Modern browsers may ignore custom beforeunload text; popstate uses confirm().
    (() => {
      if (globalThis.__cooptBackWarningInstalled) return;
      globalThis.__cooptBackWarningInstalled = true;

      const message = 'Leave this page? Unsaved changes may be lost.';
      let armed = false;
      let allowNavigation = false;

      try {
        history.pushState({ __cooptBackGuard: true, t: Date.now() }, '', location.href);
        armed = true;
      } catch (_) {
        armed = false;
      }

      window.addEventListener('popstate', () => {
        if (!armed) return;
        if (allowNavigation) return;

        const ok = window.confirm(message);
        if (ok) {
          allowNavigation = true;
          // We consumed one history step (the guard). Go back once more.
          setTimeout(() => {
            try {
              history.back();
            } catch (_) {
              // ignore
            }
          }, 0);
          return;
        }

        // Stay on the page: re-arm guard.
        try {
          history.pushState({ __cooptBackGuard: true, t: Date.now() }, '', location.href);
        } catch (_) {
          // ignore
        }
      });

      // Handle refresh/close/navigation away.
      const onBeforeUnload = (e) => {
        if (allowNavigation) return;
        try {
          e.preventDefault();
          // Safari/Chromium: custom text is typically ignored; empty string is the most compatible.
          e.returnValue = '';
          return '';
        } catch (_) {
          // ignore
        }
      };
      window.addEventListener('beforeunload', onBeforeUnload, { capture: true });
      // Some Safari versions behave more reliably with the legacy handler.
      window.onbeforeunload = onBeforeUnload;
    })();
  </script>

</head>
<body>

  <!-- LOAD SAVE --> 
  <div class="top-buttons-container">
    <div class="top-file-row" id="loaded-file-display">
      <span class="top-file-icon">ğŸ“</span>
      <span id="loaded-file-name" class="top-file-name">No file loaded</span>
      <button id="open-settings-btn" class="top-settings-btn" title="Settings">âš™ï¸</button>
    </div>
    <div class="top-buttons-row">
      <!-- File Operations Group -->
      <div class="button-group">
        <span class="button-group-label">File</span>
        <button id="save-all-btn">Save</button>
        <button id="load-all-btn">Load</button>
        <button id="share-url-btn">SHARE</button>
        <button id="clear-storage-btn">Clear Cache</button>
      </div>

      <!-- Data Exchange Group -->
      <div class="button-group">
        <span class="button-group-label">Data</span>
        <button id="import-zemax-btn" title="Import a Zemax .zmx file (minimal subset)">Import Zemax</button>
        <button id="export-zemax-btn" title="Export current optical system as Zemax .zmx">Export Zemax</button>
      </div>

      <!-- Visualization Group -->
      <div class="button-group">
        <span class="button-group-label">View</span>
        <button id="open-3d-window-btn" title="Render 3D view in popup window">Render</button>
        <button id="open-system-data-window-btn" title="Open System Data in popup window">System Data</button>
      </div>

      <!-- Tools & Analysis Group -->
      <div class="button-group">
        <span class="button-group-label">Tools</span>
        <button id="optimize-design-intent-btn" title="Optimize marked variables (V) to satisfy System Requirements (all scenarios).">Optimize</button>
        <label for="analysis-select" style="margin-left: 8px; font-size: 14px; color: #333;">Analysis:</label>
        <select id="analysis-select" style="min-width: 180px;">
          <option value="">Select Analysis...</option>
          <option value="spot-diagram">Spot Diagram</option>
          <option value="spherical-aberration">Spherical Aberration</option>
          <option value="astigmatism">Astigmatism</option>
          <option value="distortion">Distortion</option>
          <option value="integrated-aberration">Integrated Aberration</option>
          <option value="transverse-aberration">Transverse Aberration</option>
          <option value="opd">Optical Path Difference</option>
          <option value="psf">Point Spread Function</option>
          <option value="mtf">Modulation Transfer Function</option>
        </select>
      </div>
    </div>

    <!-- Hidden analysis buttons (triggered by dropdown) -->
    <div style="display: none;">
      <button id="open-spot-diagram-window-btn" title="Open Spot Diagram in popup window">Spot Diagram</button>
      <button id="open-spherical-aberration-window-btn" title="Open Spherical Aberration in popup window">Spherical Aberration</button>
      <button id="open-astigmatism-window-btn" title="Open Astigmatism in popup window">Astigmatism</button>
      <button id="open-distortion-window-btn" title="Open Distortion in popup window">Distortion</button>
      <button id="open-integrated-aberration-window-btn" title="Open Integrated Aberration in popup window">Integrated Aberration</button>
      <button id="open-transverse-aberration-window-btn" title="Open Transverse Aberration in popup window">Transverse Aberration</button>
      <button id="open-opd-window-btn" title="Open Optical Path Difference in popup window">Optical Path Difference</button>
      <button id="open-psf-window-btn" title="Open Point Spread Function in popup window">Point Spread Function</button>
      <button id="open-mtf-window-btn" title="Open Modulation Transfer Function in popup window">Modulation Transfer Function</button>
    </div>
  </div>

  <!-- System Configuration Section -->
  <div class="configuration-section">
    <h2>System Configuration</h2>
    <div class="merit-function-help">
      <strong>Note:</strong> Source and System Requirements are shared across configurations.
    </div>
    <div class="configuration-controls">
      <select id="config-select"></select>
      <button id="add-config-btn">â• Add</button>
      <button id="delete-config-btn">ğŸ—‘ï¸ Delete</button>
      <button id="duplicate-config-btn">ğŸ“‹ Duplicate</button>
      <button id="rename-config-btn">âœï¸ Rename</button>
    </div>
    <div id="config-info" class="config-info"></div>
  </div>

  <!-- Source ã¨ Object ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="source-object-container">
    <div class="source-section">
      <h2>Source</h2>
      <button id="add-source-btn">Add Source</button>
      <button id="delete-source-btn">Del Source</button>
      <div id="table-source"></div>
    </div>

    <div class="object-section">
      <h2>Object</h2>
      <button id="add-object-btn">Add Object</button>
      <button id="delete-object-btn">Del Object</button>
      <button id="object-angle-btn">Angle</button>
      <!-- <button id="object-height-circle-btn">Height Circle</button> -->
      <button id="object-height-rect-btn">Height Rect</button>
      <div id ="table-object"></div>
    </div>
  </div>

  <div class="optical-system-section">
    <h2>Design Intent</h2>
    <div class="merit-function-help">
      <strong>Note:</strong> High-level structure that defines the optical design. Expanded below into editable surfaces.
    </div>

    <div id="design-intent-toolbar" class="optical-system-buttons-container">
      <select id="design-intent-add-block-type">
        <option value="ObjectPlane">ObjectPlane</option>
        <option value="Lens">Lens</option>
        <option value="Doublet">Doublet</option>
        <option value="Triplet">Triplet</option>
        <option value="CoordBreak">CoordBreak</option>
        <option value="Gap">Gap</option>
        <option value="Stop">Stop</option>
        <option value="ImagePlane">ImagePlane</option>
      </select>
      <button id="design-intent-add-block-btn">Add</button>
      <button id="design-intent-delete-block-btn">Delete</button>
    </div>

    <div id="import-analyze-mode-banner" class="merit-function-help" style="display: none;">
      <strong>Import / Analyze Mode</strong><br>
      Imported optical systems are analyzed as surfaces.<br>
      ï¼ˆèª­ã¿è¾¼ã¿æ¸ˆã¿å…‰å­¦ç³»ã¯ Surface ã¨ã—ã¦è§£æã•ã‚Œã¾ã™ï¼‰<br>
      Design Intent (Blocks) is partial or unavailable.<br>
      ï¼ˆDesign Intentï¼ˆBlocksï¼‰ã¯éƒ¨åˆ†çš„ã€ã¾ãŸã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼‰<br><br>

      This optical system contains elements that cannot be represented as design blocks (e.g. cemented lenses).<br>
      ï¼ˆBlocks ã«è¡¨ç¾ã§ããªã„è¦ç´ ã‚’å«ã¿ã¾ã™ï¼šä¾‹ï¼šã‚»ãƒ¡ãƒ³ãƒˆæ¥åˆãƒ¬ãƒ³ã‚ºï¼‰<br><br>

      You can analyze and edit surfaces, but the design intent is not fully available.<br>
      ï¼ˆSurface ã®è§£æãƒ»ç·¨é›†ã¯å¯èƒ½ã§ã™ãŒã€è¨­è¨ˆæ„å›³ã¯å®Œå…¨ã«ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼‰
    </div>
    <div class="block-inspector-panel">
      <div id="block-inspector" class="block-inspector"></div>
    </div>

    <div class="expanded-optical-system-header">
      <h2 class="optical-system-title">Expanded Optical System (from Blocks)</h2>
      <button id="toggle-expanded-optical-system-btn" aria-expanded="true">Collapse</button>
    </div>
    <div id="expanded-optical-system-content">
      <div class="optical-system-buttons-container">
        <button id="add-optical-system-btn">Add Surf</button>
        <button id="delete-optical-system-row-btn">Del Surf</button>
        <button id="apply-to-design-intent-btn">Apply to Design Intent</button>
        <button id="find-glass-btn">ğŸ” Find Glass</button>
      </div>

      <!-- Step2: Evaluation â†’ Apply reason (read-only). Shown after cell select/edit, before Apply. -->
      <div id="apply-reason-section" class="apply-reason-section" style="display: none;">
        <div class="apply-reason-title">é©ç”¨ç†ç”±ï¼ˆå‚ç…§ç”¨ / èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰</div>
        <div class="apply-reason-help">
          ã‚»ãƒ«ã‚’é¸æŠã¾ãŸã¯ç·¨é›†ã™ã‚‹ã¨ã€å¯¾è±¡ Blockï¼ˆ_blockIdï¼‰ã«å¯¾ã™ã‚‹æœ€æ–°ã®è©•ä¾¡è¦ç´„ï¼ˆLCA/TCA å¯„ä¸ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          â€»è©•ä¾¡ã¯ã€ŒAberration Coefficientsã€å®Ÿè¡Œæ™‚ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚
        </div>
        <textarea id="apply-reason-text" rows="6" cols="100" readonly placeholder="ã“ã“ã«é©ç”¨ç†ç”±ï¼ˆè©•ä¾¡è¦ç´„ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™â€¦"></textarea>
      </div>

      <div class="optical-system-divider"></div>

      <div id="table-optical-system"></div>
    </div>
  </div>

  <!-- System Requirements Section -->
  <div class="merit-function-section">
    <h2>System Requirements</h2>

    <div class="merit-function-help">
      <strong>Note:</strong> Requirements are the pass/fail specification. All scenarios must pass.
    </div>

    <div class="merit-function-buttons-container">
      <button id="add-requirement-btn">Add Requirement</button>
      <button id="delete-requirement-btn">Del Requirement</button>
      <button id="update-requirement-btn">Update Requirement</button>
    </div>

    <div id="table-system-requirements"></div>

    <div id="requirement-inspector" class="operand-inspector" style="display: none;">
      <h3>Requirement Detail / Inspector</h3>
      <div id="requirement-inspector-content"></div>
    </div>
  </div>

  <!-- System Evaluation Section (deprecated; kept for internal engine compatibility) -->
  <div class="merit-function-section" style="display:none;">
    <h2>System Evaluation</h2>
    <div class="merit-function-help">
      <strong>Note:</strong> This evaluation encodes design intent. Optimization is optional and always explicit.
      <br>
      <strong>Terminology / ç”¨èª:</strong>
      Target = requirement valueï¼ˆè¦æ±‚å€¤ï¼ç›®æ¨™ã®æ•°å­—ï¼‰, Weight = scoring weightï¼ˆè©•ä¾¡ã®é‡ã¿ï¼æ¡ç‚¹ä¸Šã®é‡è¦åº¦ï¼‰.
    </div>
    <div class="merit-function-buttons-container">
      <button id="add-operand-btn">Add Term</button>
      <button id="delete-operand-btn">Del Term</button>
      <button id="calculate-merit-btn">Calculate Evaluation</button>
    </div>
    <div id="table-merit-function"></div>
    <div class="merit-summary">
      <strong>System Requirements Score:</strong> <span id="total-merit-value">0.000</span>
    </div>
    <div id="operand-inspector" class="operand-inspector" style="display: none;">
      <h3>Evaluation Detail / Inspector</h3>
      <div id="inspector-content"></div>
    </div>

    <div id="block-contribution-section" class="block-contribution-section" style="display: none;">
      <h3>Block Contribution Summary</h3>
      <div class="merit-function-help">
        <strong>Note:</strong> Updated when running â€œAberration Coefficientsâ€. Aggregated by expanded-row provenance (_blockId).
      </div>
      <textarea id="block-contribution-summary" rows="10" cols="100" readonly placeholder="Block contribution summary will appear here..."></textarea>
    </div>
  </div>

  <!-- System Dataã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="system-section" style="display:none;">
    <h2>System Data</h2>
    <div class="system-controls">
      <button id="calculate-paraxial-btn">Calculate Paraxial</button>
      <button id="calculate-seidel-btn">Aberration Coefficients</button>
      <button id="calculate-seidel-afocal-btn">Aberration Coefficients (Afocal)</button>
      <label for="reference-focal-length">Reference Focal Length:</label>
      <input type="text" id="reference-focal-length" placeholder="Auto" style="width: 80px;">
      <button id="coord-transform-btn">Coord Transform</button>
    </div>
    <textarea id="system-data" rows="15" cols="100" placeholder="System information will appear here..."></textarea>
  </div>

  <!-- 3Dæç”»ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="draw-system-container">
    <div class="draw-section">
      <!-- Spot diagram section -->
      <div class="spot-diagram-section" style="display:none;">
        <h2>Spot Diagram</h2>
        <div class="spot-diagram-controls">
          <label for="spot-diagram-config-select">Config:</label>
          <select id="spot-diagram-config-select"></select>

          <label for="surface-number-select">Surface number:</label>
          <select id="surface-number-select">
            <option value="">Select surface...</option>
          </select>
          <label for="ray-count-input">Ray number:</label>
          <input type="number" id="ray-count-input" value="501" min="1" max="10001" step="1">
          <label for="ring-count-select">Ring count:</label>
          <select id="ring-count-select">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10" selected>10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="20">20</option>
            <option value="24">24</option>
            <option value="32">32</option>
          </select>
          <span class="ray-count-note ring-count-note">(Limited by available rays)</span>
          
          <!-- å…‰ç·šãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ -->
          <div class="ray-pattern-controls">
            <label>Ray pattern:</label>
            <button id="annular-pattern-btn" class="pattern-btn active">Annular</button>
            <button id="grid-pattern-btn" class="pattern-btn">Rectangle</button>
          </div>
          
          <button id="show-spot-diagram-btn" title="Generate spot diagram for the selected surface">Show spot diagram</button>
        </div>
        <div class="spot-diagram-help">
          <strong>Note:</strong> 
          â€¢ Select a surface where rays can reach (usually Image surface or earlier)
          â€¢ If you get "rays not reaching surface" error, try selecting an earlier surface
          â€¢ Higher ray count provides better accuracy but takes longer to compute
        </div>
        <div id="spot-diagram-container"></div>
      </div>
      
      <!-- Spherical Aberration diagram section -->
      <div class="longitudinal-aberration-section" style="display:none;">
        <h2>Spherical Aberration Diagram</h2>
        <div class="longitudinal-aberration-help">
          <strong>Note:</strong> Spherical aberration shows the axial displacement of focus along the optical axis (X-axis: longitudinal aberration, Y-axis: normalized pupil coordinate).
        </div>
        <div class="longitudinal-aberration-controls">
          <label for="longitudinal-ray-count-input">Ray number:</label>
          <input type="number" id="longitudinal-ray-count-input" value="20" min="1" max="1001" step="1">
          <span class="note">(Always normalized by stop diameter)</span>
          <button id="show-longitudinal-aberration-diagram-btn">Show spherical aberration diagram</button>
        </div>
        <div id="longitudinal-aberration-container"></div>
      </div>
      
      <!-- Transverse Aberration diagram section -->
      <div class="transverse-aberration-section" style="display:none;">
        <h2>Transverse Aberration Diagram</h2>
        <div class="transverse-aberration-controls">
          <label for="transverse-ray-count-input">Ray number:</label>
          <input type="number" id="transverse-ray-count-input" value="101" min="1" max="1001" step="1">
          <span class="note">(Always normalized by stop diameter)</span>
          <button id="show-transverse-aberration-diagram-btn">Show transverse aberration diagram</button>
        </div>
        <div id="transverse-aberration-container"></div>
      </div>
      
      <!-- Astigmatism diagram section -->
      <div class="astigmatism-section" style="display:none;">
        <h2>Astigmatism Diagram</h2>
        <div class="astigmatism-help">
          <strong>Note:</strong> Astigmatism diagram shows the sagittal and meridional focal positions across different field angles.
        </div>
        <div class="astigmatism-controls">
          <button id="show-astigmatism-diagram-btn">Show astigmatism diagram</button>
        </div>
        <div id="astigmatism-container"></div>
        <div id="astigmatic-field-curves-container"></div>
      </div>
      
      <!-- Distortion diagram section -->
      <div class="distortion-section" style="display:none;">
        <h2>Distortion Diagram</h2>
        <div class="distortion-help">
          <strong>Note:</strong> Distortion shows the deviation of real image height from ideal (paraxial) image height.
          Field angles are automatically detected from Object table.
        </div>
        <div class="distortion-controls">
          <button id="show-distortion-diagram-btn">Show distortion diagram</button>
          <label for="grid-size-select" style="margin-left: 20px;">Grid Size:</label>
          <select id="grid-size-select">
            <option value="10">10Ã—10</option>
            <option value="15">15Ã—15</option>
            <option value="20" selected>20Ã—20</option>
            <option value="25">25Ã—25</option>
            <option value="30">30Ã—30</option>
            <option value="35">35Ã—35</option>
            <option value="40">40Ã—40</option>
            <option value="45">45Ã—45</option>
            <option value="50">50Ã—50</option>
          </select>
          <button id="show-distortion-grid-btn">Show grid distortion</button>
        </div>
        <div id="distortion-percent"></div>
        <div id="distortion-grid"></div>
      </div>
      
      <!-- Integrated Aberration Diagram section -->
      <section class="diagram-section" style="display:none;">
        <h2>Integrated Aberration Diagram</h2>
        <div class="distortion-help">
          <strong>Note:</strong> This diagram combines Spherical Aberration, Astigmatic Field Curves, and Distortion in one view.
        </div>
        <div class="distortion-controls">
          <button id="show-integrated-aberration-btn">Show integrated aberration diagram</button>
        </div>
      </section>
      
            <!-- Optical Path Difference diagram section -->
          <div class="wavefront-aberration-section" style="display:none;">
        <h2>Optical Path Difference</h2>
        <div class="wavefront-aberration-controls">
          <label for="wavefront-object-select">Object:</label>
          <select id="wavefront-object-select">
            <option value="0">Object 1</option>
            <option value="1">Object 2</option>
            <option value="2">Object 3</option>
            <option value="3">Object 4</option>
            <option value="4">Object 5</option>
          </select>
          <label for="wavefront-plot-type-select">Plot type:</label>
          <select id="wavefront-plot-type-select">
            <option value="surface">3D Surface</option>
            <option value="heatmap">Heatmap</option>
            <option value="multifield">Multi-field Comparison</option>
          </select>
          <label for="wavefront-grid-size-select">Grid size:</label>
          <select id="wavefront-grid-size-select">
            <option value="16">16x16</option>
            <option value="32">32x32</option>
            <option value="64" selected>64x64</option>
            <option value="128">128x128</option>
            <option value="256">256x256</option>
          </select>
          <button id="show-wavefront-diagram-btn">Show wavefront diagram</button>
          <button id="stop-opd-btn" type="button" disabled>Stop</button>
          <button id="zernike-fit-btn">Zernike Fit</button>
        </div>
        <div id="opd-progress" style="margin: 8px 0; font-size: 13px; color: #666;"></div>
        <div id="wavefront-container"></div>
        <div id="wavefront-container-stats"></div>
      </div>
      
      <!-- PSF diagram section -->
      <div class="psf-section" style="display:none;">
        <h2>Point Spread Function</h2>
        <div class="psf-controls">
          <label for="psf-object-select">Object:</label>
          <select id="psf-object-select">
            <option value="0">Object 1</option>
          </select>
          <label for="psf-sampling-select">FFT grid:</label>
          <select id="psf-sampling-select">
            <option value="32">32x32</option>
            <option value="64" selected>64x64</option>
            <option value="128">128x128</option>
            <option value="256">256x256</option>
            <option value="512">512x512</option>
            <option value="1024">1024x1024</option>
            <option value="2048">2048x2048</option>
            <option value="4096">4096x4096</option>
          </select>
          <label for="psf-zeropad-select" title="Zero-padding increases PSF sampling resolution by enlarging FFT size without increasing OPD ray grid.">Zero pad:</label>
          <select id="psf-zeropad-select" title="Auto: pad to at least 512. None: no padding (fast). Or choose an explicit FFT size.">
            <option value="auto" selected>Auto (â‰¥512)</option>
            <option value="none">None</option>
            <option value="512">512</option>
            <option value="1024">1024</option>
            <option value="2048">2048</option>
            <option value="4096">4096</option>
          </select>
          <label for="psf-zernike-sampling-select">OPD grid:</label>
          <select id="psf-zernike-sampling-select" title="Ray-traced OPD grid size (number of rays traced across pupil)">
            <option value="32">32x32</option>
            <option value="64" selected>64x64</option>
            <option value="128">128x128</option>
            <option value="256">256x256</option>
            <option value="512">512x512</option>
            <option value="1024">1024x1024</option>
            <option value="2048">2048x2048</option>
            <option value="4096">4096x4096</option>
          </select>
          <label>
            <input type="checkbox" id="psf-log-scale-checkbox">
            Log scale
          </label>
          <label for="psf-performance-select">Calculator:</label>
          <select id="psf-performance-select">
            <option value="auto" selected>Auto (WASM preferred)</option>
            <option value="wasm">Force WASM</option>
            <option value="javascript">Force JavaScript</option>
          </select>
          <button id="show-psf-btn" title="Calculate and display PSF from OPD data">Show PSF</button>
          <button id="stop-psf-btn" title="Stop the current PSF calculation" disabled>Stop</button>
        </div>
        <div class="psf-help" style="font-size: 12px; color: #666; margin: 10px 0;">
          <strong>Note:</strong> PSF is calculated from OPD data using Fourier transform. Generate OPD data first using the Optical Path Difference section above.
        </div>
        <div id="psf-container"></div>
        <div id="psf-container-stats"></div>
        <div id="psf-benchmark-results" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; display: none;">
          <h4>Benchmark Results</h4>
          <div id="psf-benchmark-details"></div>
        </div>
      </div>
      
      <!-- Ray visualization controls -->
      
    </div>
  </div>

  <!-- main.jsã‚’æœ€åˆã«èª­ã¿è¾¼ã‚“ã§é–¢æ•°ã‚’å®šç¾© -->
  <!--
    IMPORTANT:
    When multiple System Configurations exist, each table reads from shared localStorage keys
    (e.g. OpticalSystemTableData). On refresh, if those shared keys still contain a different
    config's data, the UI can appear to "switch" and auto-save may overwrite the active config.

    To prevent this, expand the ACTIVE configuration into the shared keys BEFORE main.js
    imports table modules.

    We only do this when the configuration system has already been initialized (systemConfigurations exists),
    to avoid wiping legacy single-config data before the migration runs.
  -->
  <script type="module">
    try {
      const systemConfigurationsJson = localStorage.getItem('systemConfigurations');
      if (systemConfigurationsJson) {
        try {
          const parsed = JSON.parse(systemConfigurationsJson);
          if (parsed && Array.isArray(parsed.configurations) && parsed.configurations.length > 0) {
            const { loadActiveConfigurationToTables } = await import('./table-configuration.js');
            loadActiveConfigurationToTables();
            console.log('âœ… [Startup] Active configuration expanded to table storage keys');
          }
        } catch (e) {
          console.warn('âš ï¸ [Startup] Failed to parse systemConfigurations; skipping pre-load:', e);
        }
      }
    } catch (e) {
      console.warn('âš ï¸ [Startup] Failed to pre-load active configuration:', e);
    }
  </script>
  <script type="module" src="main.js?v=2026-01-19a"></script>
  
  <!-- Configuration System -->
  <script type="module" src="table-configuration.js"></script>
  <script type="module" src="ui/configuration-handlers.js"></script>
  
  <!-- Merit Function Inspector (must load before editor) -->
  <script type="module" src="merit-function-inspector.js"></script>
  
  <!-- Merit Function Editor -->
  <script type="module" src="merit-function-editor.js?v=2026-01-06b"></script>

  <!-- Multi-State / Scenarios (console-driven) -->
  <script type="module" src="scenarios.js"></script>

  <!-- MVP Optimizer (console-driven; uses Blocks variable flags) -->
  <script type="module" src="optimization/optimizer-mvp.js"></script>

  <!-- System Requirements Editor -->
  <script type="module" src="system-requirements-editor.js?v=2026-01-06c"></script>
  
  <!-- PSFãƒ—ãƒ­ãƒƒãƒˆæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ -->
  <script type="module" src="eva-psf-plot.js"></script>
  
  <!-- OPDãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œãƒãƒ¼ãƒã‚¹ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ runOPDProfiling(...) ã‚’å‘¼ã³å‡ºã—ï¼‰ -->
  <script type="module" src="opd-profiler.js"></script>
  
  <!-- PSF WASMè¨ˆç®—å™¨ã‚’èª­ã¿è¾¼ã¿ -->
  <script>
    // Keep console quiet by default: suppress PSF WASM glue logs unless explicitly enabled.
    (() => {
      if (globalThis.__JS_LensDraw_PSFConsoleFilterInstalled) return;
      globalThis.__JS_LensDraw_PSFConsoleFilterInstalled = true;

      const isDebugEnabled = () => !!(globalThis.__PSF_DEBUG || globalThis.__OPD_DEBUG);
      const originalLog = console.log.bind(console);

      console.log = (...args) => {
        try {
          if (!isDebugEnabled()) {
            const first = args[0];
            if (typeof first === 'string') {
              if (
                first.includes('PSF Calculator WebAssembly module') ||
                first.includes('[WASM-C] Internal timing for')
              ) {
                return;
              }
            }
          }
        } catch {
          // If filtering fails for any reason, fall back to normal logging.
        }
        return originalLog(...args);
      };
    })();
  </script>
  <script src="psf-wasm.js"></script>

  <!-- Core functionality scripts -->
  <script>
    
        // ray-tracing.jsã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        setTimeout(async () => {
          try {
            const main = await import('./main.js?v=2026-01-19a');
            const rayTracing = await import('./raytracing/core/ray-tracing.js');
            const debugUtils = await import('./debug/debug-utils.js');
            
            // ã¾ãšmain.jsã‹ã‚‰getWASMSystemã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            if (typeof main.getWASMSystem === 'function') {
              window.getWASMSystem = main.getWASMSystem;
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            window.rayTracingModule = rayTracing;
            
            // OptimalAsphericCalculatorçµ±åˆå¾Œã®asphericSagé–¢æ•°
            window.asphericSag = async (r, params, mode = "even") => {
              if (!window.optimalCalculator) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®JavaScriptå®Ÿè£…
                return rayTracing.asphericSag(r, params, mode);
              }
              
              // å˜ä¸€å€¤ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
              const rArray = Array.isArray(r) ? r : [r];
              
              // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›
              const k = params.conic || 0;
              const coef = [params.coef1 || 0, params.coef2 || 0, params.coef3 || 0, params.coef4 || 0];
              
              // OptimalAsphericCalculatorã§æœ€é©åŒ–è¨ˆç®—
              const result = await window.optimalCalculator.calculateAsphericSag(rArray, k, coef, mode);
              
              // å˜ä¸€å€¤ã®å ´åˆã¯æœ€åˆã®å€¤ã®ã¿è¿”ã™
              return Array.isArray(r) ? result.values : result.values[0];
            };
            
                window.intersectAsphericSurface = rayTracing.intersectAsphericSurface;
            window.surfaceNormal = rayTracing.surfaceNormal;
            window.displayCacheStats = rayTracing.displayCacheStats;
            window.clearCache = rayTracing.clearCache;
            window.disableCache = rayTracing.disableCache;
            window.enableCache = rayTracing.enableCache;
            window.enableFullCache = rayTracing.enableFullCache;
            window.testCacheDebug = rayTracing.testCacheDebug;
            window.getPerformanceReport = rayTracing.getPerformanceReport;
            window.enablePerformanceOptimization = rayTracing.enablePerformanceOptimization;
            window.disablePerformanceOptimization = rayTracing.disablePerformanceOptimization;
            
            // Horneræ³•+è§£æçš„å¾®åˆ†æœ€é©åŒ–æ¸ˆã¿ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
            // asphericSagã¯æ—¢ã«OptimalAsphericCalculatorçµ±åˆæ¸ˆã¿
            
            if (typeof rayTracing.asphericSagDerivative === 'function') {
              window.asphericSagDerivative = rayTracing.asphericSagDerivative;
            }
            if (typeof rayTracing.surfaceNormal === 'function') {
              window.surfaceNormal = rayTracing.surfaceNormal;
            }
            
            // WASMãƒ‡ãƒãƒƒã‚°é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            if (typeof main.getWASMSystem === 'function') {
              window.getWASMSystem = main.getWASMSystem;
            }
            if (typeof debugUtils.debugWASMSystem === 'function') {
              window.debugWASMSystem = debugUtils.debugWASMSystem;
              window.quickWASMComparison = debugUtils.quickWASMComparison;
            }
            
            // çµã‚Šå‘¨è¾ºå…‰ç·šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
            import('./raytracing/core/ray-marginal.js').then(marginalRayModule => {
              window.calculateMarginalRay = marginalRayModule.calculateMarginalRay;
              window.calculateAllMarginalRays = marginalRayModule.calculateAllMarginalRays;
            }).catch(error => {
              console.error('âŒ çµã‚Šå‘¨è¾ºå…‰ç·šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
            });
          } catch (error) {
            console.error('âŒ ray-tracing.js ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
          }
        }, 1000);
  </script>

  <!-- çµã‚Šå‘¨è¾ºå…‰ç·šè¨ˆç®—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module" src="raytracing/core/ray-aperture-edge.js"></script>

  <!-- WASMæœ€é©åŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
  <script src="force-wasm-system.js"></script>
    <!-- NOTE: Do not load legacy ray-tracing-wasm.js here.
      It overwrites the global RayTracingWASM symbol and can hide newer exports
      (e.g. _aspheric_sag_rt10) provided by ray-tracing-wasm-v3.js. -->

  <script>
    // ForceWASMSystemã®ç¢ºå®ŸãªåˆæœŸåŒ–ç¢ºèª
    document.addEventListener('DOMContentLoaded', function() {
      // Force WASM ã‚·ã‚¹ãƒ†ãƒ ã®ç¢ºèª
      setTimeout(() => {
        if (typeof ForceWASMSystem === 'undefined') {
          console.warn('âš ï¸ ForceWASMSystem ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åºã‚’ç¢ºèªä¸­...');
          
          // æ‰‹å‹•ã§force-wasm-system.jsã‚’å†èª­ã¿è¾¼ã¿
          const script = document.createElement('script');
          script.src = 'force-wasm-system.js';
          script.onload = () => {
            console.log('âœ… ForceWASMSystem æ‰‹å‹•èª­ã¿è¾¼ã¿å®Œäº†');
            
            // çµ±åˆãƒ†ã‚¹ãƒˆå†å®Ÿè¡Œ
            if (typeof diagnosticIntegrationStatus === 'function') {
              setTimeout(() => {
                console.log('ğŸ”„ çµ±åˆçŠ¶æ…‹ã‚’å†ç¢ºèªä¸­...');
                diagnosticIntegrationStatus();
              }, 1000);
            }
          };
          document.head.appendChild(script);
        }

        setTimeout(() => {
          // console.log('ğŸ”§ [PSF] DOMContentLoadedå¾Œã®PSFã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠåˆæœŸåŒ–');
          if (typeof window.setupPSFObjectSelect === 'function') {
            window.setupPSFObjectSelect();
          }
          
          // PSF WASMçŠ¶æ³ã®åˆæœŸåŒ–
          initializePSFWasmStatus();
        }, 3000);
      }, 2000);
    });
  </script>

  <script>
    // OptimalAsphericCalculatoråˆæœŸåŒ–ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    let optimalCalculatorInitialized = false;
    let initializationPromise = null;
    
    async function ensureOptimalCalculatorReady() {
      if (optimalCalculatorInitialized) return;
      
      if (!initializationPromise) {
        initializationPromise = (async () => {
          // OptimalAsphericCalculatorã‚¯ãƒ©ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
          while (typeof OptimalAsphericCalculator === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          console.log('ğŸ¯ OptimalAsphericCalculatoråˆæœŸåŒ–ä¸­...');
          window.optimalCalculator = new OptimalAsphericCalculator();
          await window.optimalCalculator.initialize();
          
          optimalCalculatorInitialized = true;
          console.log('âœ… OptimalAsphericCalculatoråˆæœŸåŒ–å®Œäº†');
          console.log(`   æœ€é©åŒ–æˆ¦ç•¥: ${window.optimalCalculator.getActiveStrategy()}`);
          
          // çµ±åˆç¢ºèªé–¢æ•°ã‚’å®šç¾©
          window.verifyIntegration = async () => {
            console.log('ğŸ” OptimalAsphericCalculator ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªçµ±åˆç¢ºèªä¸­...');
            
            const calcStatus = window.optimalCalculator ? 'âœ…' : 'âŒ';
            console.log(`OptimalAsphericCalculator: ${calcStatus}`);
            
            if (typeof window.asphericSag === 'function') {
              const testR = 2.5;
              const testParams = { radius: 10, conic: -0.8, coef1: 0.01, coef2: 0.02, coef3: 0.03, coef4: 0.04 };
              
              const result = await window.asphericSag(testR, testParams);
              console.log('çµ±åˆç‰ˆ asphericSag ãƒ†ã‚¹ãƒˆ:', 'âœ…', result);
            }
            
            if (window.optimalCalculator) {
              const stats = window.optimalCalculator.getPerformanceStats();
              console.log('æ€§èƒ½çµ±è¨ˆ:', stats);
            }
            
            return {
              calculatorReady: !!window.optimalCalculator,
              asphericSagIntegrated: typeof window.asphericSag === 'function',
              integrationComplete: true
            };
          };
          
          // OptimalAsphericCalculatorãƒ†ã‚¹ãƒˆé–¢æ•°
          window.testOptimalCalculator = async () => {
            console.log('ğŸ¯ OptimalAsphericCalculatorçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
            
            const smallTest = await window.optimalCalculator.calculateAsphericSag([1, 2, 3, 4, 5], -0.8, [0.01, 0.02, 0.03]);
            console.log('å°è¦æ¨¡è¨ˆç®—çµæœ:', smallTest.strategy, smallTest.time + 'ms');
            
            const largeInput = Array.from({length: 100000}, (_, i) => i * 0.01);
            const largeTest = await window.optimalCalculator.calculateAsphericSag(largeInput, -0.8, [0.01, 0.02, 0.03]);
            console.log('å¤§è¦æ¨¡è¨ˆç®—çµæœ:', largeTest.strategy, largeTest.time + 'ms');
            
            return { small: smallTest, large: largeTest };
          };
          
          console.log('ğŸ¯ OptimalAsphericCalculator ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ:');
          console.log('   verifyIntegration() - çµ±åˆçŠ¶æ…‹ç¢ºèª');
          console.log('   testOptimalCalculator() - æœ€é©åŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
          
          // ForceWASMSystemã®ç¢ºå®Ÿãªåˆ©ç”¨ã‚’å¯èƒ½ã«ã™ã‚‹é–¢æ•°
          window.createWASMSystem = () => {
            if (typeof ForceWASMSystem !== 'undefined') {
              return new ForceWASMSystem();
            } else {
              console.error('âŒ ForceWASMSystem ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              return null;
            }
          };
          
          window.testWASMSystemDirect = async () => {
            console.log('ğŸ§ª WASM ã‚·ã‚¹ãƒ†ãƒ ç›´æ¥ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            if (typeof ForceWASMSystem === 'undefined') {
              console.error('âŒ ForceWASMSystem ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              console.log('ğŸ’¡ ä¿®å¾©æ–¹æ³•: ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„');
              return null;
            }
            
            try {
              const wasmSystem = new ForceWASMSystem();
              await wasmSystem.forceInitializeWASM();
              
              console.log('âœ… WASM ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–æˆåŠŸ');
              console.log('ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:', wasmSystem.getSystemStatus());
              
              // ç°¡å˜ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
              const testResult = wasmSystem.forceAsphericSag(2.5, 0.1, -0.8, 0.01, 0.02, 0.03, 0.04);
              console.log('ğŸ§® ãƒ†ã‚¹ãƒˆè¨ˆç®—çµæœ:', testResult);
              
              return wasmSystem;
            } catch (error) {
              console.error('âŒ WASM ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
              return null;
            }
          };
          
          console.log('ğŸ”§ WASMç›´æ¥ãƒ†ã‚¹ãƒˆé–¢æ•°ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ:');
          console.log('   createWASMSystem() - WASMã‚·ã‚¹ãƒ†ãƒ ä½œæˆ');
          console.log('   testWASMSystemDirect() - WASMç›´æ¥ãƒ†ã‚¹ãƒˆ');
        })();
      }
      
      await initializationPromise;
    }
    
    // WASMæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸš€ åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
      
      try {
        // åŸºæœ¬çš„ãªæ©Ÿèƒ½ã®ã¿æœ‰åŠ¹åŒ–ï¼ˆå‰Šé™¤ã•ã‚ŒãŸæœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ä¾å­˜ã‚’é™¤å»ï¼‰
        console.log('âœ… åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        console.log('   ãƒ¡ã‚¤ãƒ³å…‰å­¦è¨ˆç®—æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
        
        // Loadã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
        const loadedFileName = localStorage.getItem('loadedFileName');
        const loadedFileWarn = localStorage.getItem('loadedFileWarn');
        const fileNameElement = document.getElementById('loaded-file-name');
        if (fileNameElement) {
          if (loadedFileName) {
            fileNameElement.textContent = loadedFileName;
            fileNameElement.style.color = '#1a4d8f';
          } else {
            fileNameElement.textContent = 'No file loaded';
            fileNameElement.style.color = '#999';
          }

          if (loadedFileWarn && loadedFileName) {
            const s = String(fileNameElement.textContent || '');
            if (!s.includes('LOAD WARN')) {
              fileNameElement.textContent = s + ' (LOAD WARN)';
            }
          }
        }
        
        // System Data ã‚’å¾©å…ƒï¼ˆReference Focal Lengthï¼‰
        const systemDataJson = localStorage.getItem('systemData');
        if (systemDataJson) {
          try {
            const systemData = JSON.parse(systemDataJson);
            const refFLInput = document.getElementById('reference-focal-length');
            if (refFLInput && systemData.referenceFocalLength !== undefined) {
              refFLInput.value = systemData.referenceFocalLength;

            }
          } catch (e) {
            console.warn('âš ï¸ System Dataå¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // Configuration UI ã‚’åˆæœŸåŒ–
        if (typeof window.initializeConfigurationUI === 'function') {
          window.initializeConfigurationUI();
          console.log('âœ… Configuration UIåˆæœŸåŒ–å®Œäº†');
        } else {
          console.warn('âš ï¸ initializeConfigurationUIé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // åŸºæœ¬ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ã¿å…¬é–‹
        window.testBasicFunctionality = () => {
          console.log('ğŸ§ª åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
          
          // åŸºæœ¬çš„ãªå…‰å­¦è¨ˆç®—ãƒ†ã‚¹ãƒˆ
          if (typeof window.asphericSag === 'function') {
            try {
              const testResult = window.asphericSag(1.0, {radius: 50, conic: -0.5, coef1: 1e-6});
              console.log('âœ… éçƒé¢SAGè¨ˆç®—: æ­£å¸¸å‹•ä½œ');
              return true;
            } catch (error) {
              console.log('âŒ éçƒé¢SAGè¨ˆç®—: ã‚¨ãƒ©ãƒ¼', error);
              return false;
            }
          } else {
            console.log('âš ï¸ asphericSagé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return false;
          }
        };
        

        
      } catch (error) {
        console.warn('âš ï¸ åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã§è»½å¾®ãªã‚¨ãƒ©ãƒ¼:', error.message);
        console.log('ğŸ“‹ ã‚³ã‚¢æ©Ÿèƒ½ã¯å‹•ä½œã‚’ç¶™ç¶š');
      }
    });
    
    // PSF WASMçŠ¶æ³åˆæœŸåŒ–é–¢æ•°
    async function initializePSFWasmStatus() {
      const statusElement = document.getElementById('psf-wasm-status');
      if (!statusElement) return;
      
      try {
        // PSFCalculatorã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { PSFCalculator } = await import('./eva-psf.js');
        const psfCalculator = new PSFCalculator();
        
        // åˆæœŸåŒ–ã‚’å¾…æ©Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const wasmStatus = psfCalculator.getWasmStatus();
        
        if (wasmStatus.ready) {
          statusElement.textContent = 'WASM Status: Ready âœ…';
          statusElement.style.color = 'green';
        } else if (wasmStatus.available) {
          statusElement.textContent = 'WASM Status: Initializing... âš ï¸';
          statusElement.style.color = 'orange';
        } else {
          statusElement.textContent = 'WASM Status: JavaScript Only âŒ';
          statusElement.style.color = 'red';
        }
        
        // console.log('ğŸ”§ [PSF] WASMçŠ¶æ³åˆæœŸåŒ–å®Œäº†:', wasmStatus);
        
      } catch (error) {
        console.error('âŒ [PSF] WASMçŠ¶æ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        statusElement.textContent = 'WASM Status: Error âŒ';
        statusElement.style.color = 'red';
      }
    }
  </script>

  <footer style="display:flex;justify-content:center;align-items:center;gap:12px;padding:12px 0;font-size:12px;">
    <a href="https://x.com/yassan_8" target="_blank" rel="noopener noreferrer" aria-label="X profile: @yassan_8" title="X: @yassan_8" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;">
      <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="display:block;">
        <path fill="currentColor" d="M18.9 2H22l-6.8 7.8L23 22h-6.7l-5.2-6.7L5.3 22H2l7.4-8.5L1 2h6.8l4.7 6.1L18.9 2zm-1.2 18h1.7L7.1 3.9H5.3L17.7 20z"/>
      </svg>
      <span>@yassan_8</span>
    </a>
    <span style="opacity:0.8;">Contact: For inquiries, please reach out via X.</span>
  </footer>

</body>

</html>
