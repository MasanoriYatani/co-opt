<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSF Calculator WebAssembly Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .performance-stats { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .controls { margin: 20px 0; }
        button { margin: 5px; padding: 10px; }
        .status { font-weight: bold; }
        .status.ready { color: green; }
        .status.loading { color: orange; }
        .status.error { color: red; }
    </style>
</head>
<body>
    <h1>üî¨ PSF Calculator WebAssembly Demo</h1>
    
    <div class="controls">
        <h3>WebAssembly Status:</h3>
        <p>WASM Status: <span id="wasmStatus" class="status loading">Loading...</span></p>
        <p>Current Implementation: <span id="currentImpl">Unknown</span></p>
        
        <h3>Performance Controls:</h3>
        <button onclick="setPerformanceMode('auto')">Auto Mode</button>
        <button onclick="setPerformanceMode('wasm')">Force WASM</button>
        <button onclick="setPerformanceMode('javascript')">Force JavaScript</button>
        
        <h3>Test PSF Calculation:</h3>
        <label for="samplingSize">Sampling Size:</label>
        <select id="samplingSize">
            <option value="32">32x32</option>
            <option value="64" selected>64x64</option>
            <option value="128">128x128</option>
            <option value="256">256x256</option>
            <option value="512">512x512</option>
            <option value="1024">1024x1024</option>
            <option value="2048">2048x2048</option>
            <option value="4096">4096x4096</option>
        </select>
        <button onclick="runPSFTest()">Run PSF Test</button>
        <button onclick="runBenchmark()">Run Benchmark (256x, 512x, 1024x, 2048x)</button>
    </div>
    
    <div class="performance-stats">
        <h3>üìä Performance Statistics:</h3>
        <pre id="performanceStats">No data yet</pre>
    </div>
    
    <div id="results">
        <h3>üìã Test Results:</h3>
        <div id="testOutput">No tests run yet</div>
    </div>

    <!-- WebAssembly PSF Calculator (Êù°‰ª∂‰ªò„ÅçË™≠„ÅøËæº„Åø) -->
    <script>
        // WebAssembly„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
        let wasmAvailable = false;
        
        console.log('üîç [WASM] Starting WASM file detection...');
        
        // psf-wasm.js„ÅÆÂ≠òÂú®„ÇíÁ¢∫Ë™ç
        fetch('./psf-wasm.js', { method: 'HEAD' })
            .then(response => {
                console.log('üîç [WASM] psf-wasm.js fetch response:', response.status, response.statusText);
                if (response.ok) {
                    wasmAvailable = true;
                    console.log('‚úÖ [WASM] psf-wasm.js found, loading...');
                    // WASM„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøË™≠„ÅøËæº„Åø
                    const script = document.createElement('script');
                    script.src = './psf-wasm.js';
                    script.onload = () => {
                        console.log('‚úÖ [WASM] psf-wasm.js loaded successfully');
                        console.log('üîç [WASM] Available after load:', typeof PSFWasm);
                    };
                    script.onerror = (error) => {
                        console.warn('‚ö†Ô∏è [WASM] Failed to load psf-wasm.js:', error);
                    };
                    document.head.appendChild(script);
                } else {
                    console.warn('‚ö†Ô∏è [WASM] psf-wasm.js not found - using JavaScript fallback');
                }
            })
            .catch((error) => {
                console.warn('‚ö†Ô∏è [WASM] Cannot check psf-wasm.js availability - using JavaScript fallback');
                console.error('üîç [WASM] Fetch error:', error);
            });
    </script>
    <script type="module">
        import { PSFCalculatorAuto } from './psf-wasm-wrapper.js';
        
        let psfCalculator = null;
        
        // ÂàùÊúüÂåñ
        async function initializePSFCalculator() {
            try {
                document.getElementById('wasmStatus').textContent = 'Checking...';
                document.getElementById('wasmStatus').className = 'status loading';
                
                // WASM„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®„ÇíÂÜçÁ¢∫Ë™ç
                await new Promise(resolve => setTimeout(resolve, 500)); // Â∞ë„ÅóÂæÖÊ©ü
                
                // JavaScript„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁâàPSFË®àÁÆóÂô®„Çí‰ΩúÊàê
                const { PSFCalculator } = await import('./eva-psf.js');
                psfCalculator = new PSFCalculator();
                
                // WASM„É©„ÉÉ„Éë„Éº„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                let wasmCalculatorAvailable = false;
                try {
                    // WASM„É©„ÉÉ„Éë„Éº„ÅÆË™≠„ÅøËæº„Åø„ÇíË©¶Ë°å
                    const wasmModule = await import('./psf-wasm-wrapper.js');
                    if (wasmModule.PSFCalculatorAuto) {
                        console.log('üîç [WASM] Creating PSFCalculatorAuto instance...');
                        const wasmCalc = new wasmModule.PSFCalculatorAuto();
                        
                        // ÂàùÊúüÂåñÂÆå‰∫Ü„ÇíÂæÖÊ©üÔºàÊúÄÂ§ß5ÁßíÔºâ
                        let attempts = 0;
                        const maxAttempts = 25; // 5Áßí = 25 * 200ms
                        
                        while (attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                            const wasmStatus = wasmCalc.getWasmStatus();
                            console.log(`üîç [WASM] Status check (${attempts + 1}/${maxAttempts}):`, JSON.stringify(wasmStatus, null, 2));
                            
                            if (wasmStatus.initialized) {
                                if (wasmStatus.available && wasmStatus.ready) {
                                    psfCalculator = wasmCalc; // WASMÁâà„Å´Âàá„ÇäÊõø„Åà
                                    wasmCalculatorAvailable = true;
                                    console.log('‚úÖ [WASM] WebAssembly PSF calculator ready');
                                } else {
                                    psfCalculator = wasmCalc; // JavaScriptÁâà„Å®„Åó„Å¶‰ΩøÁî®
                                    console.log('‚ÑπÔ∏è [WASM] Using JavaScript fallback through PSFCalculatorAuto');
                                    console.log('üîç [WASM] Detailed status:', wasmStatus);
                                }
                                break;
                            }
                            attempts++;
                        }
                        
                        if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è [WASM] Initialization timeout, using basic JavaScript fallback');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è [WASM] WebAssembly not available:', error.message);
                    console.error('üîç [WASM] Full error:', error);
                }
                
                // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                if (wasmCalculatorAvailable) {
                    document.getElementById('wasmStatus').textContent = 'Ready (WASM)';
                    document.getElementById('wasmStatus').className = 'status ready';
                    document.getElementById('currentImpl').textContent = 'WASM Available';
                } else {
                    document.getElementById('wasmStatus').textContent = 'JavaScript Only';
                    document.getElementById('wasmStatus').className = 'status loading'; // „Ç™„É¨„É≥„Ç∏Ëâ≤„ÇíÁ∂≠ÊåÅ
                    document.getElementById('currentImpl').textContent = 'JavaScript Fallback';
                }
                
                updatePerformanceStats();
                console.log('‚úÖ [PSF] Calculator initialized successfully');
                
            } catch (error) {
                console.error('‚ùå [PSF] Failed to initialize PSF calculator:', error);
                document.getElementById('wasmStatus').textContent = 'Error';
                document.getElementById('wasmStatus').className = 'status error';
                document.getElementById('currentImpl').textContent = 'Initialization Failed';
                
                // ÊúÄÂæå„ÅÆÊâãÊÆµ„Å®„Åó„Å¶Âü∫Êú¨ÁöÑ„Å™PSFË®àÁÆóÂô®„ÇíË©¶Ë°å
                try {
                    const { PSFCalculator } = await import('./eva-psf.js');
                    psfCalculator = new PSFCalculator();
                    document.getElementById('wasmStatus').textContent = 'Basic JS Only';
                    document.getElementById('currentImpl').textContent = 'Basic JavaScript';
                    console.log('‚ö†Ô∏è [PSF] Fallback to basic JavaScript calculator');
                } catch (fallbackError) {
                    console.error('‚ùå [PSF] Even fallback failed:', fallbackError);
                }
            }
        }
        
        // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„É¢„Éº„ÉâË®≠ÂÆö
        window.setPerformanceMode = function(mode) {
            if (!psfCalculator) {
                alert('PSF calculator not initialized');
                return;
            }
            
            try {
                // WASMÂØæÂøúË®àÁÆóÂô®„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (typeof psfCalculator.setImplementation === 'function') {
                    psfCalculator.setImplementation(mode);
                    document.getElementById('currentImpl').textContent = mode;
                } else if (typeof psfCalculator.setPerformanceMode === 'function') {
                    psfCalculator.setPerformanceMode(mode);
                    document.getElementById('currentImpl').textContent = `${mode} (Basic)`;
                } else {
                    console.warn('‚ö†Ô∏è [PSF] Performance mode control not available');
                    document.getElementById('currentImpl').textContent = 'JavaScript Only';
                }
                updatePerformanceStats();
            } catch (error) {
                console.error('‚ùå [PSF] Failed to set performance mode:', error);
                alert(`Failed to set mode: ${error.message}`);
            }
        };
        
        // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁµ±Ë®àÊõ¥Êñ∞
        function updatePerformanceStats() {
            if (!psfCalculator) {
                document.getElementById('performanceStats').textContent = 'Calculator not initialized';
                return;
            }
            
            try {
                let performanceData = {};
                
                if (typeof psfCalculator.getPerformanceStats === 'function') {
                    performanceData = psfCalculator.getPerformanceStats();
                } else {
                    performanceData = {
                        message: 'Performance stats not available',
                        calculatorType: 'Basic JavaScript',
                        wasmSupport: false
                    };
                }
                
                document.getElementById('performanceStats').textContent = JSON.stringify(performanceData, null, 2);
                
            } catch (error) {
                console.error('‚ùå [PSF] Failed to get performance stats:', error);
                document.getElementById('performanceStats').textContent = `Error: ${error.message}`;
            }
        }
        
        // „ÉÜ„Çπ„ÉàÁî®OPD„Éá„Éº„ÇøÁîüÊàê
        function generateTestOPDData(size = 50) {
            const rayData = [];
            const center = size / 2;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = (i - center) / center;
                    const y = (j - center) / center;
                    const radius = Math.sqrt(x * x + y * y);
                    
                    if (radius <= 1.0) { // ÂÜÜÂΩ¢Áû≥ÂÜÖ
                        // ÁêÉÈù¢ÂèéÂ∑Æ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
                        const opd = 0.1 * Math.sin(radius * Math.PI);
                        
                        rayData.push({
                            pupilX: x,
                            pupilY: y,
                            opd: opd,
                            isVignetted: false
                        });
                    }
                }
            }
            
            return { rayData };
        }
        
        // PSF„ÉÜ„Çπ„ÉàÂÆüË°å
        window.runPSFTest = async function() {
            if (!psfCalculator) {
                alert('PSF calculator not ready');
                return;
            }
            
            const samplingSize = parseInt(document.getElementById('samplingSize').value);
            const testData = generateTestOPDData();
            
            try {
                document.getElementById('testOutput').innerHTML = 'Running PSF calculation...';
                
                const startTime = performance.now();
                const result = await psfCalculator.calculatePSF(testData, {
                    samplingSize: samplingSize,
                    wavelength: 0.55
                });
                const endTime = performance.now();
                
                const output = `
                    <h4>PSF Calculation Result (${samplingSize}x${samplingSize}):</h4>
                    <ul>
                        <li>Execution Time: ${(endTime - startTime).toFixed(2)} ms</li>
                        <li>Implementation: ${result.metadata?.method || 'Unknown'}</li>
                        <li>Strehl Ratio: ${result.strehlRatio?.toFixed(4) || 'N/A'}</li>
                        <li>FWHM X: ${result.fwhm?.x?.toFixed(2) || 'N/A'}</li>
                        <li>FWHM Y: ${result.fwhm?.y?.toFixed(2) || 'N/A'}</li>
                        <li>Ray Count: ${result.metadata?.rayCount || 'N/A'}</li>
                    </ul>
                `;
                
                document.getElementById('testOutput').innerHTML = output;
                updatePerformanceStats();
                
            } catch (error) {
                console.error('PSF test failed:', error);
                document.getElementById('testOutput').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        };
        
        // „Éô„É≥„ÉÅ„Éû„Éº„ÇØÂÆüË°å
        window.runBenchmark = async function() {
            if (!psfCalculator) {
                alert('PSF calculator not ready');
                return;
            }
            
            document.getElementById('testOutput').innerHTML = 'Running benchmark...';
            
            const testSizes = [256, 512, 1024, 2048];
            const testData = generateTestOPDData();
            const results = [];
            
            for (const size of testSizes) {
                // WASMÁâà„ÉÜ„Çπ„Éà
                const wasmStart = performance.now();
                try {
                    await psfCalculator.calculatePSF(testData, {
                        samplingSize: size,
                        forceImplementation: 'wasm'
                    });
                } catch (error) {
                    console.warn('WASM test failed:', error);
                }
                const wasmTime = performance.now() - wasmStart;
                
                // JavaScriptÁâà„ÉÜ„Çπ„Éà
                const jsStart = performance.now();
                await psfCalculator.calculatePSF(testData, {
                    samplingSize: size,
                    forceImplementation: 'javascript'
                });
                const jsTime = performance.now() - jsStart;
                
                results.push({
                    size: size,
                    wasmTime: wasmTime,
                    jsTime: jsTime,
                    speedup: jsTime / wasmTime
                });
            }
            
            let output = '<h4>Benchmark Results:</h4><table border="1"><tr><th>Size</th><th>WASM (ms)</th><th>JS (ms)</th><th>Speedup</th></tr>';
            for (const result of results) {
                output += `<tr>
                    <td>${result.size}x${result.size}</td>
                    <td>${result.wasmTime.toFixed(2)}</td>
                    <td>${result.jsTime.toFixed(2)}</td>
                    <td>${result.speedup.toFixed(2)}x</td>
                </tr>`;
            }
            output += '</table>';
            
            document.getElementById('testOutput').innerHTML = output;
            updatePerformanceStats();
        };
        
        // ÂàùÊúüÂåñÂÆüË°å
        initializePSFCalculator();
    </script>
</body>
</html>
