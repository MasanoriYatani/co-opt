<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated PSF Calculator Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .controls { margin: 20px 0; }
        button { margin: 5px; padding: 10px; }
        .status { font-weight: bold; }
        .status.ready { color: green; }
        .status.loading { color: orange; }
        .status.error { color: red; }
        .results { background: #f5f5f5; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üî¨ Integrated PSF Calculator Test</h1>
    
    <div class="controls">
        <h3>WASM Integration Status:</h3>
        <p>Status: <span id="status" class="status loading">Initializing...</span></p>
        <p>Current Mode: <span id="currentMode">Unknown</span></p>
        
        <h3>Test Controls:</h3>
        <button onclick="setMode('auto')">Auto Mode</button>
        <button onclick="setMode('wasm')">Force WASM</button>
        <button onclick="setMode('javascript')">Force JavaScript</button>
        
        <h3>PSF Tests:</h3>
        <label for="testSize">Sampling Size:</label>
        <select id="testSize">
            <option value="64">64x64</option>
            <option value="128" selected>128x128</option>
            <option value="256">256x256</option>
            <option value="512">512x512</option>
            <option value="1024">1024x1024</option>
            <option value="2048">2048x2048</option>
            <option value="4096">4096x4096</option>
        </select>
        <button onclick="runIntegratedTest()">Run Integrated Test</button>
        <button onclick="runComparison()">Compare WASM vs JS</button>
    </div>
    
    <div class="results">
        <h3>üìä Test Results:</h3>
        <div id="testOutput">No tests run yet</div>
    </div>

    <script type="module">
        import PSFCalculator from './eva-psf.js';
        
        let psfCalculator = null;
        
        // ÂàùÊúüÂåñ
        async function initializePSFCalculator() {
            try {
                document.getElementById('status').textContent = 'Initializing...';
                
                psfCalculator = new PSFCalculator();
                
                // WASMÂàùÊúüÂåñ„ÇíÂæÖÊ©ü
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const wasmStatus = psfCalculator.getWasmStatus();
                
                if (wasmStatus.ready) {
                    document.getElementById('status').textContent = 'Ready (WASM Available)';
                    document.getElementById('status').className = 'status ready';
                } else if (wasmStatus.available) {
                    document.getElementById('status').textContent = 'WASM Initializing...';
                    document.getElementById('status').className = 'status loading';
                } else {
                    document.getElementById('status').textContent = 'JavaScript Only';
                    document.getElementById('status').className = 'status error';
                }
                
                document.getElementById('currentMode').textContent = wasmStatus.currentMode;
                
                console.log('‚úÖ Integrated PSF Calculator initialized');
                
            } catch (error) {
                console.error('‚ùå PSF Calculator initialization failed:', error);
                document.getElementById('status').textContent = 'Error';
                document.getElementById('status').className = 'status error';
            }
        }
        
        // „É¢„Éº„ÉâË®≠ÂÆö
        window.setMode = function(mode) {
            if (psfCalculator) {
                psfCalculator.setPerformanceMode(mode);
                document.getElementById('currentMode').textContent = mode;
                console.log(`üîÑ Mode set to: ${mode}`);
            }
        };
        
        // „ÉÜ„Çπ„ÉàOPD„Éá„Éº„ÇøÁîüÊàê
        function generateTestOPD(size = 50) {
            const rayData = [];
            const center = size / 2;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const x = (i - center) / center;
                    const y = (j - center) / center;
                    const radius = Math.sqrt(x * x + y * y);
                    
                    if (radius <= 1.0) {
                        const opd = 0.1 * Math.sin(radius * Math.PI) * Math.cos(2 * Math.atan2(y, x));
                        
                        rayData.push({
                            pupilX: x,
                            pupilY: y,
                            opd: opd,
                            isVignetted: false
                        });
                    }
                }
            }
            
            return { rayData };
        }
        
        // Áµ±Âêà„ÉÜ„Çπ„ÉàÂÆüË°å
        window.runIntegratedTest = async function() {
            if (!psfCalculator) {
                alert('PSF calculator not ready');
                return;
            }
            
            const samplingSize = parseInt(document.getElementById('testSize').value);
            const output = document.getElementById('testOutput');
            
            output.innerHTML = `Running integrated test (${samplingSize}x${samplingSize})...`;
            
            try {
                const testData = generateTestOPD();
                const startTime = performance.now();
                
                const result = await psfCalculator.calculatePSF(testData, {
                    samplingSize: samplingSize
                });
                
                const endTime = performance.now();
                const executionTime = endTime - startTime;
                
                output.innerHTML = `
                    <h4>‚úÖ Test Completed (${samplingSize}x${samplingSize})</h4>
                    <p><strong>Method:</strong> ${result.metadata.method}</p>
                    <p><strong>Execution Time:</strong> ${executionTime.toFixed(2)}ms</p>
                    <p><strong>Strehl Ratio:</strong> ${result.strehlRatio.toFixed(4)}</p>
                    <p><strong>FWHM:</strong> X=${result.fwhm.x.toFixed(2)}, Y=${result.fwhm.y.toFixed(2)}</p>
                    <p><strong>Ray Count:</strong> ${result.rayCount || 'N/A'}</p>
                    <p><strong>Calculator:</strong> ${result.metadata.calculator}</p>
                `;
                
                console.log('‚úÖ Integrated test completed:', result);
                
            } catch (error) {
                output.innerHTML = `<p style="color: red;">‚ùå Test failed: ${error.message}</p>`;
                console.error('‚ùå Test failed:', error);
            }
        };
        
        // ÊØîËºÉ„ÉÜ„Çπ„ÉàÂÆüË°å
        window.runComparison = async function() {
            if (!psfCalculator) {
                alert('PSF calculator not ready');
                return;
            }
            
            const samplingSize = parseInt(document.getElementById('testSize').value);
            const output = document.getElementById('testOutput');
            
            output.innerHTML = `Running comparison test (${samplingSize}x${samplingSize})...`;
            
            try {
                const testData = generateTestOPD();
                
                // WASM „ÉÜ„Çπ„Éà
                const wasmStart = performance.now();
                const wasmResult = await psfCalculator.calculatePSF(testData, {
                    samplingSize: samplingSize,
                    forceImplementation: 'wasm'
                });
                const wasmTime = performance.now() - wasmStart;
                
                // JavaScript „ÉÜ„Çπ„Éà
                const jsStart = performance.now();
                const jsResult = await psfCalculator.calculatePSF(testData, {
                    samplingSize: samplingSize,
                    forceImplementation: 'javascript'
                });
                const jsTime = performance.now() - jsStart;
                
                const speedup = jsTime / wasmTime;
                
                output.innerHTML = `
                    <h4>üèÅ Comparison Results (${samplingSize}x${samplingSize})</h4>
                    <table border="1" style="border-collapse: collapse; width: 100%;">
                        <tr><th>Method</th><th>Time (ms)</th><th>Strehl Ratio</th><th>Calculator</th></tr>
                        <tr>
                            <td>WASM</td>
                            <td>${wasmTime.toFixed(2)}</td>
                            <td>${wasmResult.strehlRatio.toFixed(4)}</td>
                            <td>${wasmResult.metadata.calculator}</td>
                        </tr>
                        <tr>
                            <td>JavaScript</td>
                            <td>${jsTime.toFixed(2)}</td>
                            <td>${jsResult.strehlRatio.toFixed(4)}</td>
                            <td>${jsResult.metadata.calculator}</td>
                        </tr>
                    </table>
                    <p><strong>Speedup:</strong> ${speedup.toFixed(2)}x faster with WASM</p>
                `;
                
                console.log('‚úÖ Comparison completed:', { wasmResult, jsResult, speedup });
                
            } catch (error) {
                output.innerHTML = `<p style="color: red;">‚ùå Comparison failed: ${error.message}</p>`;
                console.error('‚ùå Comparison failed:', error);
            }
        };
        
        // ÂàùÊúüÂåñÂÆüË°å
        initializePSFCalculator();
    </script>
</body>
</html>
