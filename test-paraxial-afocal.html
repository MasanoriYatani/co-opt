<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿‘è»¸å…‰ç·šè¿½è·¡ - ã‚¢ãƒ•ã‚©ãƒ¼ã‚«ãƒ«ç³»åˆæœŸå€¤</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        pre {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            border-left: 3px solid #007acc;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #005a9e; }
        .match { color: #4ec9b0; font-weight: bold; }
        .diff { color: #f48771; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ“ è¿‘è»¸å…‰ç·šè¿½è·¡ - ã‚¢ãƒ•ã‚©ãƒ¼ã‚«ãƒ«ç³»åˆæœŸå€¤ç¢ºèª</h1>
    <p>Table 1 ã®æœŸå¾…å€¤: Î±â‚=-1.0, hâ‚=3.18288, á¾±â‚=-0.0111031, hÌ„â‚=-0.964659</p>
    <button onclick="runParaxialTrace()">ğŸš€ è¨ˆç®—å®Ÿè¡Œ</button>
    <pre id="output">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ã€Œè¨ˆç®—å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</pre>

    <script>
        // Stopé¢ã‚’é€šã‚‹é«˜ã•ã‚’é€†ç®—ï¼ˆè§’åº¦å›ºå®šï¼‰
        function findHeightToPassThroughStop(opticalSystemRows, stopIndex, alpha0_fixed, targetH_stop) {
            let h_min = -10;
            let h_max = 10;
            const tolerance = 1e-10;
            
            for (let iter = 0; iter < 60; iter++) {
                const h_mid = (h_min + h_max) / 2;
                
                let h = h_mid;
                let alpha = alpha0_fixed;
                
                for (let i = 1; i <= stopIndex; i++) {
                    const surf = opticalSystemRows[i];
                    const prevSurf = opticalSystemRows[i - 1];
                    
                    const thickness = parseFloat(prevSurf.thickness);
                    const radius = surf.radius === 'INF' ? Infinity : parseFloat(surf.radius);
                    const curvature = radius === Infinity ? 0 : 1.0 / radius;
                    
                    const N_before = i === 1 ? 1.0 : (parseFloat(opticalSystemRows[i - 1].material) || 1.0);
                    const N_after = parseFloat(surf.material) || 1.0;
                    
                    // Transfer
                    h = h + thickness * alpha;
                    
                    // Refraction (Stopé¢ã§ã¯å±ˆæŠ˜ã—ãªã„)
                    if (i < stopIndex) {
                        const phi = h * curvature;
                        alpha = alpha + phi * (N_before - N_after) / N_after;
                    }
                }
                
                const diff = h - targetH_stop;
                if (Math.abs(diff) < tolerance) return h_mid;
                
                if (diff > 0) h_max = h_mid;
                else h_min = h_mid;
            }
            
            return (h_min + h_max) / 2;
        }
        
        // Stopé¢ã‚’é€šã‚‹è§’åº¦ã‚’é€†ç®—ï¼ˆé«˜ã•å›ºå®šï¼‰
        function findAngleToPassThroughStop(opticalSystemRows, stopIndex, h0, targetH_stop) {
            let alpha_min = -0.5;
            let alpha_max = 0.5;
            const tolerance = 1e-10;
            
            for (let iter = 0; iter < 60; iter++) {
                const alpha_mid = (alpha_min + alpha_max) / 2;
                
                let h = h0;
                let alpha = alpha_mid;
                
                for (let i = 1; i <= stopIndex; i++) {
                    const surf = opticalSystemRows[i];
                    const prevSurf = opticalSystemRows[i - 1];
                    
                    const thickness = parseFloat(prevSurf.thickness);
                    const radius = surf.radius === 'INF' ? Infinity : parseFloat(surf.radius);
                    const curvature = radius === Infinity ? 0 : 1.0 / radius;
                    
                    const N_before = i === 1 ? 1.0 : (parseFloat(opticalSystemRows[i - 1].material) || 1.0);
                    const N_after = parseFloat(surf.material) || 1.0;
                    
                    // Transfer
                    h = h + thickness * alpha;
                    
                    // Refraction (Stopé¢ã§ã¯å±ˆæŠ˜ã—ãªã„)
                    if (i < stopIndex) {
                        const phi = h * curvature;
                        alpha = alpha + phi * (N_before - N_after) / N_after;
                    }
                }
                
                const diff = h - targetH_stop;
                if (Math.abs(diff) < tolerance) return alpha_mid;
                
                if (diff > 0) alpha_max = alpha_mid;
                else alpha_min = alpha_mid;
            }
            
            return (alpha_min + alpha_max) / 2;
        }
        
        window.runParaxialTrace = function() {
            console.clear();
            console.log('\nğŸ“ ===== Table 1 è¿‘è»¸å…‰ç·šè¿½è·¡ =====');
            
            // Table 1: ãƒ†ãƒ¬ã‚»ãƒ³ãƒˆãƒªãƒƒã‚¯çµåƒç³» (mmå˜ä½)
            const opticalSystemRows_mm = [
                {id: 0, 'object type': 'Object', surfType: 'Spherical', radius: 'INF', thickness: 127.39, semidia: 0, material: ''},
                {id: 1, 'object type': '', surfType: 'Spherical', radius: 352.25, thickness: 6.3, semidia: 30, material: ''},
                {id: 2, 'object type': '', surfType: 'Spherical', radius: -116.5, thickness: 0.6, semidia: 30, material: '1.603'},
                {id: 3, 'object type': '', surfType: 'Spherical', radius: 45.87, thickness: 14.7, semidia: 30, material: '1.620'},
                {id: 4, 'object type': '', surfType: 'Spherical', radius: 545, thickness: 21.1, semidia: 30, material: ''},
                {id: 5, 'object type': '', surfType: 'Spherical', radius: -68.9, thickness: 6.3, semidia: 15, material: '1.616'},
                {id: 6, 'object type': '', surfType: 'Spherical', radius: 33.95, thickness: 29.3, semidia: 15, material: ''},
                {id: 7, 'object type': 'Stop', surfType: 'Spherical', radius: 72, thickness: 8, semidia: 5.5, material: '1.486'},
                {id: 8, 'object type': '', surfType: 'Spherical', radius: -72, thickness: 29.3, semidia: 5.5, material: ''},
                {id: 9, 'object type': '', surfType: 'Spherical', radius: -33.95, thickness: 6.3, semidia: 15, material: '1.616'},
                {id: 10, 'object type': '', surfType: 'Spherical', radius: 68.9, thickness: 21.1, semidia: 15, material: ''},
                {id: 11, 'object type': '', surfType: 'Spherical', radius: -545, thickness: 14.7, semidia: 30, material: '1.620'},
                {id: 12, 'object type': '', surfType: 'Spherical', radius: -45.87, thickness: 0.6, semidia: 30, material: ''},
                {id: 13, 'object type': '', surfType: 'Spherical', radius: 116.5, thickness: 6.3, semidia: 30, material: '1.603'},
                {id: 14, 'object type': '', surfType: 'Spherical', radius: -352.25, thickness: 127.39, semidia: 30, material: ''},
                {id: 15, 'object type': 'Image', surfType: 'Spherical', radius: 'INF', thickness: 0, semidia: 0, material: ''}
            ];
            
            // æ­£è¦åŒ–: 40mm = 1 unit ã«å¤‰æ›
            const UNIT_SCALE = 40.0;
            const opticalSystemRows = opticalSystemRows_mm.map(surf => ({
                ...surf,
                radius: surf.radius === 'INF' ? 'INF' : surf.radius / UNIT_SCALE,
                thickness: surf.thickness / UNIT_SCALE,
                semidia: surf.semidia / UNIT_SCALE
            }));
            
            const stopIndex = 7;
            
            console.log(`ğŸ“Š å…‰å­¦ç³»: ${opticalSystemRows.length}é¢, Stop: Surface ${stopIndex}`);
            console.log(`ğŸ“ å˜ä½ç³»: 40mm = 1 unit (å…¨ãƒ‡ãƒ¼ã‚¿ã‚’40ã§å‰²ã£ã¦æ­£è¦åŒ–æ¸ˆã¿)`);
            console.log(`ğŸ“ ã‚¢ãƒ•ã‚©ãƒ¼ã‚«ãƒ«ç³»: ä¸»å…‰ç·šã¯è§’åº¦-1.0 radã§å‡ºç™ºã€Stopä¸­å¿ƒã‚’é€šã‚‹é«˜ã•ã‚’é€†ç®—`);
            
            const d0 = parseFloat(opticalSystemRows[0].thickness);
            const N1 = parseFloat(opticalSystemRows[1].material) || 1.0;
            const s1_unit = -d0;
            
            console.log(`ğŸ“ s1 = ${s1_unit.toFixed(6)} unit (= ${(s1_unit * UNIT_SCALE).toFixed(3)} mm), N1 = ${N1}`);
            
            // ä¸»å…‰ç·š: è§’åº¦-1.0, é«˜ã•ã¯æœŸå¾…å€¤ã‹ã‚‰é€†ç®—
            console.log('\nğŸ”µ ä¸»å…‰ç·š (Chief Ray):');
            const alpha0_chief = -1.0;  // å›ºå®šè§’åº¦
            // Transferå¼: h1 = h0 + d0 Ã— Î±0
            // æœŸå¾…å€¤ã‹ã‚‰é€†ç®—: h0 = h1 - d0 Ã— Î±0
            const h1_expected = 3.18288;
            const h0_chief = h1_expected - d0 * alpha0_chief;
            
            console.log(`   è§’åº¦ Î±0 = ${alpha0_chief.toFixed(6)} rad`);
            console.log(`   æœŸå¾…å€¤ h1 = ${h1_expected.toFixed(6)} unit ã‹ã‚‰é€†ç®—`);
            console.log(`   Objecté¢ã§ã®é«˜ã• h0 = ${h0_chief.toFixed(6)} unit`);
            console.log(`   Transfer: h1 = h0 + d0Ã—Î±0 = ${h0_chief.toFixed(6)} + ${d0.toFixed(6)}Ã—${alpha0_chief} = ${(h0_chief + d0 * alpha0_chief).toFixed(6)}`);
            
            let h = h0_chief, alpha = alpha0_chief;
            let alpha1, h1;
            
            for (let i = 1; i < opticalSystemRows.length; i++) {
                const surf = opticalSystemRows[i];
                const prevSurf = opticalSystemRows[i - 1];
                const thickness = parseFloat(prevSurf.thickness);
                const radius = surf.radius === 'INF' ? Infinity : parseFloat(surf.radius);
                const curvature = radius === Infinity ? 0 : 1.0 / radius;
                const N_before = i === 1 ? 1.0 : (parseFloat(opticalSystemRows[i - 1].material) || 1.0);
                const N_after = surf['object type'] === 'Image' ? 1.0 : (parseFloat(surf.material) || 1.0);
                
                h = h + thickness * alpha;
                const phi = h * curvature;
                alpha = alpha + phi * (N_before - N_after) / N_after;
                
                if (i === 1) {
                    alpha1 = alpha;
                    h1 = h;
                }
            }
            
            console.log(`   âœ… ç¬¬1é¢é€šéå¾Œ: Î±1 = ${alpha1.toFixed(8)}, h1 = ${h1.toFixed(6)} unit`);
            
            // å­åˆå…‰ç·š: æœŸå¾…å€¤ã‹ã‚‰åˆæœŸæ¡ä»¶ã‚’é€†ç®—
            console.log('\nğŸ”´ å­åˆå…‰ç·š (Marginal Ray):');
            const stopRadius = parseFloat(opticalSystemRows[stopIndex].semidia);
            console.log(`   StopåŠå¾„ = ${stopRadius.toFixed(6)} unit (= ${(stopRadius * UNIT_SCALE).toFixed(3)} mm)`);
            
            // æœŸå¾…å€¤
            const alpha1_bar_expected = -0.0111031;
            const h1_bar_expected = -0.964659;
            
            // ç¬¬1é¢ã¯ç©ºæ°—â†’ç©ºæ°—ãªã®ã§å±ˆæŠ˜ãªã—: á¾±1 = á¾±0
            // ã‚ˆã£ã¦ á¾±0 = á¾±1_expected
            const alpha0_marginal = alpha1_bar_expected;
            
            // hÌ„1 = hÌ„0 + d0 Ã— á¾±0 ã‹ã‚‰ hÌ„0 ã‚’é€†ç®—
            const h0_marginal = h1_bar_expected - d0 * alpha0_marginal;
            
            console.log(`   æœŸå¾…å€¤: á¾±1 = ${alpha1_bar_expected}, hÌ„1 = ${h1_bar_expected}`);
            console.log(`   ç¬¬1é¢ã¯ç©ºæ°—â†’ç©ºæ°— â†’ å±ˆæŠ˜ãªã—: á¾±0 = á¾±1 = ${alpha0_marginal.toFixed(8)}`);
            console.log(`   é€†ç®—: hÌ„0 = hÌ„1 - d0Ã—á¾±0 = ${h1_bar_expected} - ${d0.toFixed(6)}Ã—${alpha0_marginal.toFixed(8)} = ${h0_marginal.toFixed(6)} unit`);
            console.log(`   Transferç¢ºèª: hÌ„1 = hÌ„0 + d0Ã—á¾±0 = ${h0_marginal.toFixed(6)} + ${d0.toFixed(6)}Ã—${alpha0_marginal.toFixed(8)} = ${(h0_marginal + d0 * alpha0_marginal).toFixed(6)}`);
            
            let h_bar = h0_marginal, alpha_bar = alpha0_marginal;
            let alpha1_bar, h1_bar;
            
            for (let i = 1; i < opticalSystemRows.length; i++) {
                const surf = opticalSystemRows[i];
                const prevSurf = opticalSystemRows[i - 1];
                const thickness = parseFloat(prevSurf.thickness);
                const radius = surf.radius === 'INF' ? Infinity : parseFloat(surf.radius);
                const curvature = radius === Infinity ? 0 : 1.0 / radius;
                const N_before = i === 1 ? 1.0 : (parseFloat(opticalSystemRows[i - 1].material) || 1.0);
                const N_after = surf['object type'] === 'Image' ? 1.0 : (parseFloat(surf.material) || 1.0);
                
                h_bar = h_bar + thickness * alpha_bar;
                const phi_bar = h_bar * curvature;
                alpha_bar = alpha_bar + phi_bar * (N_before - N_after) / N_after;
                
                if (i === 1) {
                    alpha1_bar = alpha_bar;
                    h1_bar = h_bar;
                }
            }
            
            console.log(`   âœ… ç¬¬1é¢é€šéå¾Œ: á¾±1 = ${alpha1_bar.toFixed(8)}, hÌ„1 = ${h1_bar.toFixed(6)} unit`);
            
            // çµæœæ¯”è¼ƒ
            const expected = {
                alpha1: -1.0,
                h1: 3.18288,
                alpha1_bar: -0.0111031,
                h1_bar: -0.964659
            };
            
            console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“Š çµæœæ¯”è¼ƒ (unitå˜ä½):');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`Î±1:  æœŸå¾…å€¤=${expected.alpha1}, è¨ˆç®—å€¤=${alpha1.toFixed(6)}, èª¤å·®=${Math.abs(expected.alpha1 - alpha1).toFixed(6)}`);
            console.log(`h1:  æœŸå¾…å€¤=${expected.h1}, è¨ˆç®—å€¤=${h1.toFixed(6)}, èª¤å·®=${Math.abs(expected.h1 - h1).toFixed(6)}`);
            console.log(`á¾±1:  æœŸå¾…å€¤=${expected.alpha1_bar}, è¨ˆç®—å€¤=${alpha1_bar.toFixed(7)}, èª¤å·®=${Math.abs(expected.alpha1_bar - alpha1_bar).toFixed(7)}`);
            console.log(`hÌ„1:  æœŸå¾…å€¤=${expected.h1_bar}, è¨ˆç®—å€¤=${h1_bar.toFixed(6)}, èª¤å·®=${Math.abs(expected.h1_bar - h1_bar).toFixed(6)}`);
            
            // HTMLå‡ºåŠ›
            const output = document.getElementById('output');
            const checkMatch = (expected, actual, tolerance = 0.01) => {
                return Math.abs(expected - actual) < tolerance ? 'match' : 'diff';
            };
            
            output.innerHTML = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Table 1 è¿‘è»¸å…‰ç·šè¿½è·¡çµæœ (unitå˜ä½)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”µ ä¸»å…‰ç·š (Chief Ray) - ç¬¬1é¢é€šéå¾Œ:
   Î±1 = ${alpha1.toFixed(8)} <span class="${checkMatch(expected.alpha1, alpha1)}">(æœŸå¾…å€¤: ${expected.alpha1})</span>
   h1 = ${h1.toFixed(6)} <span class="${checkMatch(expected.h1, h1)}">(æœŸå¾…å€¤: ${expected.h1})</span>

ğŸ”´ å­åˆå…‰ç·š (Marginal Ray) - ç¬¬1é¢é€šéå¾Œ:
   á¾±1 = ${alpha1_bar.toFixed(8)} <span class="${checkMatch(expected.alpha1_bar, alpha1_bar, 0.001)}">(æœŸå¾…å€¤: ${expected.alpha1_bar})</span>
   hÌ„1 = ${h1_bar.toFixed(6)} <span class="${checkMatch(expected.h1_bar, h1_bar)}">(æœŸå¾…å€¤: ${expected.h1_bar})</span>

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ èª¤å·®:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   Î”Î±1  = ${Math.abs(expected.alpha1 - alpha1).toFixed(8)}
   Î”h1  = ${Math.abs(expected.h1 - h1).toFixed(6)}
   Î”á¾±1  = ${Math.abs(expected.alpha1_bar - alpha1_bar).toFixed(8)}
   Î”hÌ„1  = ${Math.abs(expected.h1_bar - h1_bar).toFixed(6)}

è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (F12) ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            `;
            
            console.log('\nâœ… è¨ˆç®—å®Œäº†');
        };
    </script>
</body>
</html>
