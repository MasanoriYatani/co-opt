<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Memory Test</title>
</head>
<body>
    <h1>WASM Memory Access Test</h1>
    <div id="results"></div>
    
    <script src="psf-wasm.js"></script>
    <script>
        const results = document.getElementById('results');
        
        async function testWasmMemory() {
            try {
                results.innerHTML += '<p>üîç Testing WASM memory access...</p>';
                
                // PSFWasm„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (typeof PSFWasm === 'undefined') {
                    results.innerHTML += '<p>‚ùå PSFWasm not found</p>';
                    return;
                }
                
                results.innerHTML += '<p>‚úÖ PSFWasm found</p>';
                
                // „É¢„Ç∏„É•„Éº„É´„Çí‰ΩúÊàê
                const module = await PSFWasm();
                results.innerHTML += '<p>‚úÖ Module created</p>';
                
                // Âü∫Êú¨Ê©üËÉΩ„Çí„ÉÜ„Çπ„Éà
                const tests = {
                    '_malloc': !!module._malloc,
                    '_free': !!module._free,
                    'cwrap': !!module.cwrap,
                    'setValue': !!module.setValue,
                    'getValue': !!module.getValue,
                    'HEAPF64': !!module.HEAPF64,
                    'HEAPU8': !!module.HEAPU8,
                    'HEAP8': !!module.HEAP8,
                    'HEAP16': !!module.HEAP16,
                    'HEAP32': !!module.HEAP32
                };
                
                results.innerHTML += '<h3>Available Functions/Objects:</h3>';
                for (const [name, available] of Object.entries(tests)) {
                    results.innerHTML += `<p>${available ? '‚úÖ' : '‚ùå'} ${name}</p>`;
                }
                
                // „É°„É¢„É™„ÉÜ„Çπ„Éà
                results.innerHTML += '<h3>Memory Access Test:</h3>';
                
                try {
                    const ptr = module._malloc(64); // 8 doubles
                    results.innerHTML += '<p>‚úÖ Memory allocated</p>';
                    
                    // HEAPF64„Çí‰Ωø„Å£„Åü„ÉÜ„Çπ„Éà
                    if (module.HEAPF64) {
                        const heapIndex = ptr / 8;
                        module.HEAPF64[heapIndex] = 3.14159;
                        const value = module.HEAPF64[heapIndex];
                        results.innerHTML += `<p>‚úÖ HEAPF64 access: ${value}</p>`;
                    } else {
                        results.innerHTML += '<p>‚ùå HEAPF64 not available</p>';
                    }
                    
                    // setValue/getValue„Çí‰Ωø„Å£„Åü„ÉÜ„Çπ„Éà
                    if (module.setValue && module.getValue) {
                        module.setValue(ptr, 2.71828, 'double');
                        const value = module.getValue(ptr, 'double');
                        results.innerHTML += `<p>‚úÖ setValue/getValue: ${value}</p>`;
                    } else {
                        results.innerHTML += '<p>‚ùå setValue/getValue not available</p>';
                    }
                    
                    module._free(ptr);
                    results.innerHTML += '<p>‚úÖ Memory freed</p>';
                    
                } catch (memError) {
                    results.innerHTML += `<p>‚ùå Memory test failed: ${memError.message}</p>`;
                }
                
                // Âà©Áî®ÂèØËÉΩ„Å™Èñ¢Êï∞‰∏ÄË¶ß
                const wasmFunctions = Object.keys(module).filter(key => 
                    key.startsWith('_') && typeof module[key] === 'function'
                );
                
                results.innerHTML += '<h3>WASM Functions:</h3>';
                results.innerHTML += `<p>${wasmFunctions.slice(0, 20).join(', ')}</p>`;
                
                // PSFÁâπÊúâ„ÅÆÈñ¢Êï∞„ÇíÁ¢∫Ë™ç
                const psfFunctions = wasmFunctions.filter(name => 
                    name.includes('psf') || name.includes('calculate') || name.includes('fft')
                );
                
                if (psfFunctions.length > 0) {
                    results.innerHTML += '<h3>PSF Functions:</h3>';
                    results.innerHTML += `<p>${psfFunctions.join(', ')}</p>`;
                } else {
                    results.innerHTML += '<p>‚ùå No PSF functions found</p>';
                }
                
            } catch (error) {
                results.innerHTML += `<p>‚ùå Test failed: ${error.message}</p>`;
                console.error('WASM test error:', error);
            }
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂæå„Å´„ÉÜ„Çπ„ÉàÂÆüË°å
        window.addEventListener('load', testWasmMemory);
    </script>
</body>
</html>
