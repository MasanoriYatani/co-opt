<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒãƒƒãƒˆãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .console-output { background: #f0f0f0; padding: 15px; border-radius: 5px; max-height: 600px; overflow-y: auto; }
        .log { color: #000; }
        .warn { color: #ff6600; }
        .error { color: #cc0000; }
        button { margin: 10px 5px 0 0; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ã‚¹ãƒãƒƒãƒˆãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ãƒ‡ãƒãƒƒã‚°</h1>
    <button id="test-btn">ray-renderer.js ã®ãƒ†ã‚¹ãƒˆ</button>
    <button id="test-html-btn">HTML ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ç¢ºèª</button>
    <button id="test-logic-btn">annular ãƒªãƒ³ã‚°ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ</button>
    
    <div class="console-output" id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'log') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            output.appendChild(div);
            console.log(msg);
        }
        
        document.getElementById('test-html-btn').addEventListener('click', () => {
            output.innerHTML = '';
            log('ğŸ” HTML ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ç¢ºèª...');
            
            const ringSelect = document.getElementById('ring-count-select');
            if (!ringSelect) {
                log('âŒ ring-count-select ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            log(`âœ… ring-count-select found: ${ringSelect.id}`);
            const options = ringSelect.querySelectorAll('option');
            log(`ğŸ“Š ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°: ${options.length}`);
            options.forEach((opt, i) => {
                if (i < 5 || i >= options.length - 2) {
                    log(`  [${i}] value="${opt.value}" text="${opt.text}"`);
                } else if (i === 5) {
                    log(`  ...`);
                }
            });
            
            const currentValue = ringSelect.value;
            log(`ğŸ“Œ ç¾åœ¨ã®å€¤: ${currentValue}`);
        });
        
        document.getElementById('test-logic-btn').addEventListener('click', async () => {
            output.innerHTML = '';
            log('ğŸ” annular ãƒªãƒ³ã‚°ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ...');
            log('');
            
            // ãƒ†ã‚¹ãƒˆç”¨ã® annular ãƒ­ã‚¸ãƒƒã‚¯
            function testAnnularGeneration(rayCount, annularRingCount) {
                const rays = [];
                
                // Chief ray
                rays.push({ type: 'chief' });
                let raysGenerated = 1;
                const remainingRays = Math.max(rayCount - 1, 0);
                
                if (remainingRays > 0) {
                    let numRings;
                    if (annularRingCount) {
                        // Use explicit ring count
                        numRings = Math.min(annularRingCount, remainingRays);
                    } else {
                        // Auto-calc
                        if (remainingRays <= 6) numRings = 1;
                        else if (remainingRays <= 15) numRings = 2;
                        else if (remainingRays <= 30) numRings = 3;
                        else if (remainingRays <= 50) numRings = 4;
                        else if (remainingRays <= 80) numRings = 5;
                        else if (remainingRays <= 120) numRings = 6;
                        else if (remainingRays <= 170) numRings = 7;
                        else numRings = 8;
                    }
                    
                    for (let ringIndex = 1; ringIndex <= numRings && raysGenerated < rayCount; ringIndex++) {
                        const raysInThisRing = Math.ceil((rayCount - raysGenerated) / (numRings - ringIndex + 1));
                        for (let i = 0; i < raysInThisRing && raysGenerated < rayCount; i++) {
                            rays.push({ type: `ring_${ringIndex}` });
                            raysGenerated++;
                        }
                    }
                    
                    return { rays, numRings, raysGenerated };
                }
                
                return { rays, numRings: 0, raysGenerated };
            }
            
            // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
            const testCases = [
                { rayCount: 501, ringCount: 3, desc: 'æ—¢å®š: 501rays, 3rings' },
                { rayCount: 501, ringCount: 8, desc: 'ä¿®æ­£å¾Œ: 501rays, 8rings' },
                { rayCount: 501, ringCount: 16, desc: 'æ‹¡å¼µ: 501rays, 16rings' },
                { rayCount: 501, ringCount: null, desc: 'Auto: 501rays, auto-calc' }
            ];
            
            testCases.forEach(tc => {
                const result = testAnnularGeneration(tc.rayCount, tc.ringCount);
                log(`${tc.desc}:`);
                log(`  ãƒªãƒ³ã‚°æ•°: ${result.numRings}, ç·å…‰ç·šæ•°: ${result.raysGenerated}`);
            });
        });
        
        document.getElementById('test-btn').addEventListener('click', async () => {
            output.innerHTML = '';
            log('ğŸ” ray-renderer.js ã®ãƒ†ã‚¹ãƒˆ...');
            log('');
            
            try {
                // ray-renderer.js ã‚’ãƒ­ãƒ¼ãƒ‰
                const module = await import('./optical/ray-renderer.js');
                
                if (module.normalizeAnnularRingCount) {
                    log('âœ… normalizeAnnularRingCount ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                    
                    const testValues = [null, undefined, 3, 8, 16, 32];
                    testValues.forEach(val => {
                        try {
                            const result = module.normalizeAnnularRingCount(val);
                            log(`  normalizeAnnularRingCount(${val}) = ${result}`);
                        } catch (e) {
                            log(`  âŒ Error: ${e.message}`, 'error');
                        }
                    });
                } else {
                    log('âš ï¸ normalizeAnnularRingCount ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warn');
                }
                
                if (module.generateRayStartPointsForObject) {
                    log('âœ… generateRayStartPointsForObject ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                } else {
                    log('âŒ generateRayStartPointsForObject ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
                
            } catch (error) {
                log(`âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`è©³ç´°: ${error.stack}`, 'error');
            }
        });
    </script>
</body>
</html>
